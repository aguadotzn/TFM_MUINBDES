\capitulo{7}{Entorno experimental}

En esta sección se va a exponer el entorno con el que se ha realizado el estudio. 


\section{Esquema}

A modo de introducción se han seguido cuatro partes principales en el desarrollo técnico del proyecto en las que se han utilizado diferentes habilidades. Los siguientes esquemas (ver figuras \ref{diagramtechA} y \ref{diagramtechB}) describen de manera la línea a seguir en el proyecto.

   \imagen{diagramtechA}{\footnotesize{Detalle diagrama desarrollo (Partes 1 y 2). Fuente: Elaboración propia.}\label{diagramtechA}}
    \imagen{diagramtechB}{\footnotesize{Detalle diagrama desarrollo (Partes 3 y 4). Fuente: Elaboración propia.}\label{diagramtechB}}

\section{Fuente datos origen}

En el presente proyecto se han utilizado \textit{datasets} obtenidos principalmente a través de portales de datos abiertos, siendo esta la principal fuente de datos. Estos portales ponen a disposición pública múltiples sets de datos siguiendo una estrategia basada en cuatro aspectos fundamentales: la apertura de datos, la transparencia, la interacción y la participación de personas y/o empresas. 

El portal de Datos Abiertos del Ayuntamiento de Madrid, se dedica a promover el acceso a los datos del gobierno municipal y trata de impulsar el desarrollo de herramientas creativas para atraer y servir a la ciudadanía de Madrid. 
Este portal dispone de un amplio catálogo de datos que puede ser descargado a través de un acceso web para el público general (descarga ordinaria) y un \textit{API REST} con el que automatizar y programar el acceso y descarga de los diferentes \textit{datasets}. A través de este portal \cite{portal_datosabiertos_madrid}, es posible descargar un set de datos de calidad del aire con mediciones horarias y diarias desde el año 2001 hasta la actualidad. También existen datos en tiempo real.

Por lo tanto los tres tipos de ficheros que podemos descargar son los siguientes:

\begin{itemize}
	\item \textbf{Datos de calidad del aire diarios}: en este conjunto de datos se puede obtener la información recogida por las estaciones de control de calidad del aire, con los \textbf{datos diarios} por anualidades de 2001 a 2019. 
	\item \textbf{Datos de calidad del aire horarios:} en este conjunto de datos se puede obtener la información recogida por las estaciones de control de calidad del aire, con los \textbf{datos horarios} por anualidades de 2001 a 2019. Los datos horarios de las magnitudes corresponden a la media aritmética de los valores diezminutales que se registran cada hora.
	\item \textbf{Datos de calidad del aire en tiempo real:} En este conjunto de datos se puede obtener la información actualizada en tiempo real.
\end{itemize}

En el caso concreto del proyecto nos vamos a centrar en los dos primeros. En el caso de los \textbf{datos horarios}, éstos viene comprimidos en un archivo \textit{.zip} y cuando nos los descargamos aparecen divididos por meses. El nombre del archivo esta formado por las tres letras primeras, que corresponden al mes más un guión bajo seguido de dos números \textit{XX}, que identifican al año.

En caso de los \textbf{datos diarios} es similar pero nos proponen el formato de descarga directamente desde la web.

Los principales aspectos a destacar de la fuente de datos serían: 
\begin{itemize}
	\item Los ficheros están en texto plano, \textit{.csv} o \textit{.xml} y los campos no se encuentran delimitados.
	\item Caso\textbf{ datos diarios}: los datos se encuentran almacenados mensualmente y agrupados en ficheros comprimidos por cada año.
	\item Caso\textbf{ datos horarios}: cada registro contiene los 24 valores horarios de un día, 30 ó 31 filas contiguas corresponden a los valores de los días del mes, repitiéndose con cada magnitud (contaminante) de todas las estaciones que lo miden. Cada fichero contiene un mes de observaciones.
	\item Se dispone de mediciones de calidad del aire desde el año 2001 hasta la actualidad. 
	\item Cada campo tiene asignado un determinado número de dígitos. 
	\item Todos los campos contienen datos numéricos ya sean identificadores o medidas.
	\item Hay que precisar que las medidas válidas están marcadas con una V y las medidas no válidas están marcadas con una N. Tan solo serán validas las que contienen la V.
	\item Los datos anteriores a 2010 presentan algunos errores, meses vacío y los formatos están delimitados-
\end{itemize}

La tabla 7.5 contiene los código de interpretación de los \textbf{datos horarios}. Tres apuntes importantes:

\begin{enumerate}
\item El campo punto de muestreo incluye el código de la estación completo (provincia, municipio y estación) más la magnitud y la técnica de muestreo.

\item H01 corresponde al dato de la 1 de la mañana de ese día, V01 es el código de validación, H02 al de las 2 de la mañana, V02 y así sucesivamente.

\item Únicamente son válidos los datos que llevan el código de validación “V".
\end{enumerate}


%DATOS HORARIOS
\begin{table}[H]
	\begin{center}
		\begin{tabular}{|c|c|}
			\hline
			\textbf{PROVINCIA}       & \textit{28}              \\ \hline
			\textbf{MUNICIPIO}       & \textit{79}              \\ \hline
			\textbf{ESTACION}        & \textit{4}               \\ \hline
			\textbf{MAGNITUD}        & \textit{1}               \\ \hline
			\textbf{PUNTO\_MUESTREO} & \textit{28079004\_1\_38} \\ \hline
			\textbf{ANO}             & \textit{2019}            \\ \hline
			\textbf{MES}             & \textit{1}               \\ \hline
			\textbf{DIA}             & \textit{1}               \\ \hline
			\textbf{H01}             & \textit{23}              \\ \hline
			\textbf{V01}             & \textit{V}               \\ \hline
			\textbf{H02}             & \textit{17}              \\ \hline
			\textbf{V02}             & \textit{V}               \\ \hline
			\textbf{[...]}             & \textit{[...]}               \\ \hline
		\end{tabular}
		\caption{Tabla intérprete valores horarios.}
	\end{center}
\label{TablaValHorarios}
\end{table}

La tabla 7.6 contiene los código de interpretación de los \textbf{datos diarios}. Tres apuntes importantes:

\begin{enumerate}
	\item El campo punto de muestreo incluye el código de la estación completo (provincia, municipio y estación) más la magnitud y la técnica de muestreo.
	
	\item D01 corresponde al dato del primer día del mes, D02 al del segundo día y así sucesivamente.
	
	\item Únicamente son válidos los datos que llevan el código de validación “V".
\end{enumerate}

%VALORES DIARIOS
\begin{table}[H]
	\begin{center}
		\begin{tabular}{|c|c|}
			\hline
			\textbf{PROVINCIA}       & \textit{28}              \\ \hline
			\textbf{MUNICIPIO}       & \textit{79}              \\ \hline
			\textbf{ESTACION}        & \textit{4}               \\ \hline
			\textbf{MAGNITUD}        & \textit{1}               \\ \hline
			\textbf{PUNTO\_MUESTREO} & \textit{28079004\_1\_38} \\ \hline
			\textbf{ANO}             & \textit{2019}            \\ \hline
			\textbf{MES}             & \textit{1}               \\ \hline
			\textbf{D01}             & \textit{18}              \\ \hline
			\textbf{V01}             & \textit{V}               \\ \hline
			\textbf{D02}             & \textit{20}              \\ \hline
			\textbf{V02}             & \textit{V}               \\ \hline
			\textbf{[...]}             & \textit{[...]}               \\ \hline
		\end{tabular}
	\caption{Tabla intérprete valores diarios.}
	\end{center}
\label{TablaValDiarios}
\end{table}


Como ya hemos nombrado anteriormente, el Sistema de Vigilancia está formado por 24 estaciones remotas automáticas que recogen la información básica para la vigilancia atmosférica. Poseen los analizadores necesarios para la medida correcta de los niveles de gases y de partículas. La localización de las estaciones de control también se encuentra para su libre descarga, este caso se permiten los ficheros \textit{.xls}, \textit{.csv} y \textit{.geo}. La tabla 7.7 contiene los datos para la correcta interpretación de los ficheros.

Recordemos que las estaciones se agrupan por zonas:

\begin{itemize}
	\item Zona 1
	\begin{itemize}
		\item Mendez Álvaro
		\item Arganzuela
		\item Carlos V
		\item Parque del Retiro
		\item Escuelas Aguirre
		\item Plaza del Carmen
		\item Paseo de Recoletos
		\item Plaza de España
		\item Manuel Becerra
		\item Barrio Salamanca
		\item Castellana
		\item Gregorio Marañon
		\item Cuatro Caminos
		\item Ciudad Universitaria
		\item Avenida Ramón y Cajal
		\item Plaza Castilla
		\item Barrio del Pilar
	\end{itemize}
	\item Zona 2
	\begin{itemize}
		\item Moratalaz
		\item Vallecas
		\item Santa Eugenia
		\item Ensanche de Vallecas
	\end{itemize}
	\item Zona 3
	\begin{itemize}
		\item Arturo Soria
		\item Campo de las Naciones
		\item Juan Carlos I
		\item Urbanización Embajada
		\item Barajas Pueblo
		\item San Chinarro
		\item Tres Olivos Plaza
	\end{itemize}
	\item Zona 4
	\begin{itemize}
		\item El Pardo
		\item Casa de Campo
		\item Alto de Extremadura
	\end{itemize}
	\item Zona 5
	\begin{itemize}
		\item Farolillo
		\item Cuatro Vientos
		\item Plaza Fernández Ladreda (Elíptica)
		\item Villaverde
	\end{itemize}
\end{itemize}



%TABLA ESTACIONES
\begin{table}[H]
			\begin{center}
	\begin{tabular}{|c|c|c|}
	
		\hline
		\textbf{Código estación} & \textbf{Lugar}       & \textbf{Comentarios}         \\ \hline
		\textit{28079001}        & Pº. Recoletos        & Baja.- 04/05/2009 (14:00 h.) \\ \hline
		\textit{28079002}        & Glta. de Carlos V    & Baja.- 04/12/2006 (11:00 h.) \\ \hline
		\textit{28079003}        & Pza. del Carmen      & * Código desde enero 2011    \\ \hline
		\textit{28079004}        & Pza. de España       &                              \\ \hline
		\textit{28079005}        & Barrio del Pilar     & * Código desde enero 2011    \\ \hline
		\textit{28079006}        & Pza. Dr. Marañón     & Baja.- 27/11/2009 (08:00 h.) \\ \hline
		\textit{28079007}        & Pza. M. de Salamanca & Baja.- 30/12/2009 (14:00 h.) \\ \hline
		\textit{28079008}        & Escuelas Aguirre     &                              \\ \hline
		\textit{28079009}        & Pza. Luca de Tena    & Baja.- 07/12/2009 (08:00 h.) \\ \hline
		\textit{28079010}        & Cuatro Caminos       & * Código desde enero 2011    \\ \hline
		\textit{28079011}        & Av. Ramón y Cajal    &                              \\ \hline
		\textit{28079012}        & Pza. Manuel Becerra  & Baja.- 30/12/2009 (14:00 h.) \\ \hline
		\textit{28079013}        & Vallecas             & * Código desde enero 2011    \\ \hline
		\textit{28079014}        & Pza. Fdez. Ladreda   & Baja.- 02/12/2009 (09:00 h.) \\ \hline
		\textit{28079015}        & Pza. Castilla        & Baja.- 17/10/2008 (11:00 h.) \\ \hline
		\textit{28079016}        & Arturo Soria         &                              \\ \hline
		\textit{28079017}        & Villaverde Alto      &                              \\ \hline
		\textit{28079018}        & C/ Farolillo         &                              \\ \hline
		\textit{28079019}        & Huerta Castañeda     & Baja.- 30/12/2009 (13:00 h.) \\ \hline
		\textit{28079020}        & Moratalaz            & * Código desde enero 2011    \\ \hline
		\textit{28079021}        & Pza. Cristo Rey      & Baja.- 04/12/2009 (14:00 h.) \\ \hline
		\textit{28079022}        & Pº. Pontones         & Baja.- 20/11/2009 (10:00 h.) \\ \hline
		\textit{28079023}        & Final C/ Alcalá      & Baja.- 30/12/2009 (14:00 h.) \\ 	\hline
		\textit{28079024} & Casa de Campo           &                                                                                                  \\ \hline
		\textit{28079025} & Santa Eugenia           & Baja.- 16/11/2009 (10:00 h.)                                                                     \\ \hline
		\textit{28079026} & Urb. Embajada (Barajas) & Baja.- 11/01/2010 (09:00 h.)                                                                     \\ \hline
		\textit{28079027} & Barajas                 &                                                                                                  \\ \hline
		\textit{28079047} & Méndez Álvaro           & Alta.- 21/12/2009 (00:00 h.)                                                                     \\ \hline
		\textit{28079048} & Pº. Castellana          & Alta.- 01/06/2010 (00:00 h.)                                                                     \\ \hline
		\textit{28079049} & Retiro                  & Alta.- 01/01/2010 (00:00 h.)                                                                     \\ \hline
		\textit{28079050} & Pza. Castilla           & Alta.- 08/02/2010 (00:00 h.)                                                                     \\ \hline
		\textit{28079054} & Ensanche Vallecas       & Alta.- 11/12/2009 (00:00 h.)                                                                     \\ \hline
		\textit{28079055} & Urb. Embajada (Barajas) & Alta.- 20/01/2010 (15:00 h.)                                                                     \\ \hline
		\textit{28079056} & Plaza Elíptica          & Alta.- 18/01/2010 (12:00 h.)                                                                     \\ \hline
		\textit{28079057} & Sanchinarro             & Alta.- 24/11/2009 (00:00 h.)                                                                     \\ \hline
		\textit{28079058} & El Pardo                & Alta.- 30/11/2009 (13:00 h.)                                                                     \\ \hline
		\textit{28079059} & Parque Juan Carlos I    & Alta.- 14/12/2009 (00:00 h.)                                                                     \\ \hline
		\textit{28079086} & Tres Olivos    & Alta.- 14/01/2010 (13:00 h.)                                                                    \\ \hline
	
\end{tabular}
	\caption{Tabla intérprete estaciones de control.}
	\end{center}	
\end{table}

Y para terminar los contaminantes, descritos en la tabla 7.8, también es necesario interpretarlos.

%TABLA CONTAMINANTES
\begin{table}[H]
		\begin{center}
	\begin{tabular}{|c|c|c|c|c|c|}
		\hline
		\multicolumn{2}{|c|}{\textbf{Magnitud}}     & \textbf{Abreviatura} & \textbf{Unidad} & \multicolumn{2}{c|}{\textbf{Técnica de medida}} \\ \hline
		01 & \textit{Dióxido de Azufre}             & \ce{SO2}                  & \textmugreek g/m3    & 38               & Fluorescencia ultravioleta         \\ \hline
		06 & \textit{Monóxido de Carbono}           & \ce{CO}                   & mg/m3   & 48               & Absorción infrarroja               \\ \hline
		08 & \textit{Dióxido de Nitrógeno}           & \ce{NO2}                   & \textmugreek g/m3           & 48         &  Id.               \\ \hline
		
		07 & \textit{Monóxido de Nitrógeno}         & \ce{NO}                   & \textmugreek g/m3           & 08         & Quimioluminiscencia                \\ \hline
		09 & \textit{Partículas \textless 2.5 \textmugreek m}   & \ce{PM2,5}                & \textmugreek g/m3           & 47         & Microbalanza                       \\ \hline
		10 & \textit{Partículas \textless 10 \textmugreek m}    & \ce{PM10}                 & \textmugreek g/m3           & 47         & Id.                                \\ \hline
		12 & \textit{Óxidos de Nitrógeno}           & \ce{NOx}                  & \textmugreek g/m3           & 08         & Quimioluminiscencia                \\ \hline
		20 & \textit{Tolueno}                       & \ce{TOL}                  & \textmugreek g/m3           & 59         & Gases                              \\ \hline
		30 & \textit{Benceno}                       & \ce{BEN}                  & \textmugreek g/m3           & 59         & Id.                                \\ \hline
		35 & \textit{Etilbenceno}                   & \ce{EBE}                  & \textmugreek g/m3           & 59         & Id.                                \\ \hline
		37 & \textit{Metaxileno}                    & \ce{MXY}                  & \textmugreek g/m3           & 59         & Id.                                \\ \hline
		38 & \textit{Paraxileno}                    & \ce{PXY}                  & \textmugreek g/m3           & 59         & Id.                                \\ \hline
		39 & \textit{Ortoxileno}                    & \ce{OXY}                  & \textmugreek g/m3           & 59         & Id.                                \\ \hline
		42 & \textit{Hidrocarburos totales(hexano)} & \ce{TCH}                  & mg/m3           & 02         & Ionización de llama                \\ \hline
		43 & \textit{Metano}                        & \ce{CH4}                  & mg/m3           & 02         & Id.                                \\ \hline
		44 & Hidrocarburos no metánicos             & \ce{NMHC}                & mg/m3           & 02         & Id.                                \\ \hline
	\end{tabular}
	\caption{Tabla ínterprete contaminantes.}
\end{center}	
\end{table}


\section{Exploración}
Tras conocer, estudiar a fondo los tipos de datos existentes y su correcta interpretación es tiempo de explorarlos. La fase de exploración se ha realizado de diferentes maneras y desde varias perspectivas con la ayuda de diversas herramientas \textit{open source}.

Esta fase es necesaria para realizar una investigación preliminar con el fin de entender mejor las características específicas de nuestros datos. En esta fase buscaremos correlaciones, tendencias y valores atípicos. Sin esta fase, no podríamos utilizar los datos de manera eficaz. Hemos hecho uso de diversas herramientas como es el caso de \href{http://vega.github.io/}{Voyager2} (figura \ref{voyager}).

    \imagen{voyager}{\footnotesize{Detalle \textit{vega-voyager}. Fuente: Elaboración propia.}\label{voyager}}
    
Datawrapper (ver figura \ref{datawrapper}) es otra herramienta que nos ayuda a analizar nuestros datos de una manera rápida. Es conveniente no coger una muestra demasiado grande ya que, ni es necesario, ni el software está correctamente optimizado para grandes volúmenes.
    
        \imagen{datawrapper}{\footnotesize{Detalle \textit{Datawrapper}. Fuente: Elaboración propia.}\label{datawrapper}}
 
A continuación, en las tablas 7.9 y 7.9, se expone la tipología de las variables en su conjunto. Aunque es posible que no se utilicen todas, sí es necesario introducir aquí todas las variables para establecer una relación con lo descrito en páginas anteriores.

    %DATOS HORARIOS
    \begin{table}[H]
    	\begin{center}
    		\begin{tabular}{|c|c|}
    			\hline
    			\textbf{PROVINCIA}       & \textit{integer}              \\ \hline
    			\textbf{MUNICIPIO}       & \textit{integer}              \\ \hline
    			\textbf{ESTACION}        & \textit{integer}               \\ \hline
    			\textbf{MAGNITUD}        & \textit{integer}               \\ \hline
    			\textbf{PUNTO\_MUESTREO} & \textit{integer} \\ \hline
    			\textbf{ANO}             & \textit{integer}            \\ \hline
    			\textbf{MES}             & \textit{integer}               \\ \hline
    			\textbf{DIA}             & \textit{integer}               \\ \hline
    			\textbf{H01}             & \textit{integer}              \\ \hline
    			\textbf{V01}             & \textit{float}               \\ \hline
    			\textbf{H02}             & \textit{integer}              \\ \hline
    			\textbf{V02}             & \textit{text}               \\ \hline
    			\textbf{[...]}             & \textit{[...]}               \\ \hline
    		\end{tabular}
    		\caption{Tabla tipo datos valores horarios.}
    	\end{center}
    \end{table}

%DATOS DIARIOS
\begin{table}[H]
	\begin{center}
		\begin{tabular}{|c|c|}
			\hline
			\textbf{PROVINCIA}       & \textit{integer}              \\ \hline
			\textbf{MUNICIPIO}       & \textit{integer}              \\ \hline
			\textbf{ESTACION}        & \textit{integer}               \\ \hline
			\textbf{MAGNITUD}        & \textit{integer}               \\ \hline
			\textbf{PUNTO\_MUESTREO} & \textit{integer} \\ \hline
			\textbf{ANO}             & \textit{integer}            \\ \hline
			\textbf{MES}             & \textit{integer}               \\ \hline
			\textbf{D01}             & \textit{integer}              \\ \hline
			\textbf{V01}             & \textit{text}               \\ \hline
			\textbf{D02}             & \textit{integer}              \\ \hline
			\textbf{V02}             & \textit{text}               \\ \hline
			\textbf{[...]}             & \textit{[...]}               \\ \hline
		\end{tabular}
		\caption{Tabla tipo datos valores diarios.}
	\end{center}
\end{table}

Para conocer más a fondo nuestros datos algunas estadísticas básicas de este tipo que podemos calcular para nuestro conjunto de datos son la media, mediana, máximos, mínimos o distribuciones. 

\imagen{Restadisticas.png}{\footnotesize{Ejemplo estadísticas con R de algunas horas. Fuente: Elaboración propia.}\label{tiny1}} 

Son muy interesantes para este estudio los promedios y la media de los gases contaminantes además de los máximos. En numerosas ocasiones organismos como la OMS \cite{oms_1} dictaminan episodios de contaminación en función de la media cada \textit{x} período horario. Cada contaminante tiene sus medidas y cada organismo dictamina su correcta interpretación.

 
\section{Transformación de datos}
Tras explorar y entender los datos es hora de transformarlos de acuerdo a nuestros objetivos finales. Es cierto que se han utilizado diferentes lenguajes de programación pero en todos se han seguido patrones comunes a la hora de transformar los datos.

Algunas características comunes de la transformación de los datos han sido el renombramiento de columnas, el establecer el tipo de dato adecuado por columnas para realizar operaciones y evitar problemas a la hora de realizar operaciones, el intercambiar las columnas de validación para establecer los datos que son correctos o el agrupar por contenido para obtener una determinada gráfica. Además se han limpiado las columnas no válidas, se han desechado las que no iban a usarse y se han agrupado las columnas de tipo fecha. 

Por otro lado, en algunas ocasiones los cálculos de promedios, medias o recuentos se han realizado directamente sobre \textit{PowerBi.} Los niveles marcados por la OMS en algunas ocasiones son fijos por lo que también se han añadido de manera manual cuando ha sido necesario. 

Vamos a poner un ejemplo del procedimiento a seguir para \href{https://tinybird.co//}{Tinybird.co}. Lo primero que hay que hacer es cargar los datos. Como hemos nombrado se trata de una aplicación en beta por lo tanto el entorno gráfico no está disponible todavía para subir cantidades  grandes de datos por lo que se ha creado un script en bash que a través de un bucle sube todos los archivos. 

\lstset{breaklines=true, basicstyle=\footnotesize}
\begin{lstlisting}[frame=single]
#!/bin/bash

#Personal Token
TOKEN=p.eyXXXXXXXXXXXXXXXXXXXXXX
#URL
BASE_URL=/Users/xxxx/Documents//TFM_MUINBDES/Code/data

#Load months
for month in ene feb mar abr may jun jul ago sep oct nov dic
do
curl -F "csv=@${month}_mo18.csv" \
-H "Authorization: Bearer $TOKEN" \
-X POST "https://XXXXXXXXXXX/v0/datasources?name=datos_2018&mode=append"
done
\end{lstlisting}

Una vez tenemos los datos cargados (ver figura \ref{tiny1}) es el momento de transformar los datos de acuerdo a nuestro estudio particular. 

\imagen{tinybird1}{\footnotesize{Datos cargados en \textit{tinybird}. Fuente: Elaboración propia.}\label{tiny1}}

En este caso queremos observar si existen patrones anuales en los datos de la cantidad de \ce{NO2} para después comprobar la misma hipótesis de manera semanal y por horas. Lo primero que hacemos es seleccionar de nuestro conjunto de datos lo que nos hace falta, además transformamos la fecha (ya que recordamos que la fecha viene en nuestro fichero de datos original separada en tres columnas diferentes) para una mejor visualización (ver figura \ref{tiny2}).

\imagen{tinybird2}{\footnotesize{Detalle \textit{tinybird}. Fuente: Elaboración propia.}\label{tiny2}}

Después escogemos los valores válidos y también la magnitud que corresponde al contaminante del cuál queremos hacer el análisis (ver figura \ref{tiny3})

\imagen{tinybird3}{\footnotesize{Detalle \textit{tinybird}. Fuente: Elaboración propia.}\label{tiny3}}

Para terminar agrupamos y ordenamos por lo que nos hace falta para nuestro análisis (ver figura \ref{tiny4}) y ya podemos exportar el archivo para proceder a su visualización.

\imagen{tinybird4}{\footnotesize{Detalle \textit{tinybird}. Fuente: Elaboración propia.}\label{tiny4}}

 En el caso de python, cuyo archivo final se ha utilizado para la visualización interactiva, el proceso ha sido muy similar con la peculiaridad de que se han añadido los datos de las estaciones de medida al fichero final. En este caso, como ya he nombrado, se han escogido los datos de 2014 a 2018. Se han seleccionado los datos directamente desde la web para evitar inconsistencias. Hemos tenido que lidiar con los archivos en \textit{.txt}, ya que algunos años solo aparecían en este formato. Hemos hecho un \textit{merge} de los datos de las estaciones junto con los datos de los gases para establecer por estación los tipos de gases medidos. De esta manera se ha logrado enriquecer la visualización añadiendo correspondencia por zonas y estaciones.

\section{Visualización de datos}
Una vez que tenemos los datos transformados de manera adecuada ya podemos concentrarnos en la parte visual. En este trabajo la parte visual está dividia en varias partes, por un lado en todas las gráficas que hemos empleado para explorar los datos; segundo, en una visualización final a modo de \textit{dashboard} realizada con \textit{PowerBi}; y, por último, en una pequeña web resumen de datos interesantes.


Siguiendo con el ejemplo nombrado en el apartado anterior y cargando los datos en \textit{vega} podemos obtener la visualización de acuerdo a nuestro objetivo. En este caso hemos calculado la media de \ce{NO2} por mes (en naranja) junto con los máximos (en azul)  del año 2019, concretamente de enero a julio. En la siguiente figura \ref{NO22019} podemos ver el gráfico de líneas.

\imagen{NO22019}{\footnotesize{Detalle \ce{NO2} 2019. Fuente: Elaboración propia.}\label{NO22019}}


También lo mismo pero por día de la semana (ver figura \ref{ejemploJulio}), en este caso para el mes de julio y con un gráfico de barras.

\imagen{ejemploJulio}{\footnotesize{Detalle \ce{NO2} 2019 (julio). Fuente: Elaboración propia.}\label{ejemploJulio}}


Y lo mismo pero por horas, en este caso para el 1 de julio (ver figura \ref{ejemplo01julio}) y con un gráfico de puntos.
\imagen{ejemplo01julio}{\footnotesize{Detalle \ce{NO2} 2019 (1 julio). Fuente: Elaboración propia.}\label{ejemplo01julio}}

Con estas tres figuras anteriores ya comenzamos a ver patrones en los datos de los cuales hablaremos en la parte de resultados.

La parte de la visualización en \textbf{PowerBi} es más interactiva y refleja una parte de los datos, 2014 a 2018, desde el punto de vista de la OMS y los gases que esta organización refleja como más perjudiciales para la salud.  Una vez transformados los datos y con el fichero limpio se cargan los datos. He realizado distintas páginas dentro de \textit{PowerBi }en las que podemos ver diferentes tipos de gráficos.

\begin{itemize}
	\item \textbf{Página 1}: Portada del trabajo
	\item \textbf{Página 2}: Resumen de todos los contaminantes por zonas y años. De este modo se puede ver la variación a lo largo del tiempo de todos los contaminantes principales.
	\item \textbf{Página 3} (ver figura \ref{PowerBi2}): Esta página-resumen es la misma que la anterior pero en esta ocasión nos centramos tan solo en  \ce{NO2} y se expone la variabilidad por días de la semana pudiendo ver de manera rápida los días más afectados.
	\imagen{pagina2PowerBi.png}{\footnotesize{Detalle gráfico por día de la semana. Fuente: Elaboración propia.}\label{PowerBi2}}

	\item \textbf{Página 4}: \textit{límites anuales (OMS)},	se exponen aquí la media de las partículas por millón de \ce{PM2,5} y \ce{PM10} , además de  \ce{NO2}.  La línea azul refleja el nivel recomendado por la OMS. Es posible filtar por zonas y ver en las gráficas de barras donde se superan los niveles. Se ve que se respetan los niveles en casi todos los casos y en otros vemos que se supera lo establecido por la OMS.
	
	\item \textbf{Página 5} (ver figura \ref{pagina5}):  \textit{límites diarios (OMS)}, en este caso volvemos a escoger las partículas por millón de \ce{PM2,5} y \ce{PM10} , además de \ce{NO2}. Es importante conocer aquí que dependiendo del contaminante se establecen unos límites distintos por la OMS. En este caso se establecen los límites por día. La línea azul refleja ese límite y los gráficos de color naraja la media diaria para esos valores seleccionados. Es posible también filtrar por zonas y estaciones. 
	
	\imagen{pagina5}{\footnotesize{Detalle límite diario OMS. Fuente: Elaboración propia.}\label{pagina5}}
	
	\item \textbf{Página 6}: nos centramos en los dos contaminantes más criticos según la OMS, el ozono (\ce{O3}) y el dióxido de nitrógeno (\ce{NO2}). La OMS recomienda un máximo para la media cada ocho horas. Se reflejan en los gráficos ambos contaminantes respectivamente en el primer y segundo gráfico. Como se puede ver superamos con creces los niveles de \ce{O3}.
	
	\imagen{pagina6}{\footnotesize{Detalles \ce{O3} y \ce{NO2}  . Fuente: Elaboración propia.}\label{pagina6}}
	
	\item \textbf{Página 7}: El procolo anticontaminación es superado en numerosas ocasiones por los diferentes niveles que son los que ponen en alerta al Ayuntamiento. En este informe podemos ver el número de veces que se supera por zonas. El objetivo es poder filtrar con detalle por zona, estación y período.  
	
	\item \textbf{Página 8}: La media de \ce{NO2} es la que se utiliza para ver si se han superado esos niveles de los que hablábamos. En esta ocasión podemos ver dos gráficos de líneas que nos sirven para comparar entre estaciones y por período/fecha si se han superado los niveles.
	
	\item \textbf{Página 9} (ver figura \ref{MapaNO2}): Es posible ver aquí otra interpretación de la página anterior. En esta ocasión se representa la  acumulación de \ce{NO2} por zonas y horas de manera visual. Concretamente se hace uso de un mapa utilizando un \textit{plugin} de \textit{mapbox}. 
	
	En color amarillo los que ya han superado ese 180 (preaviso), en color rojo los que han superado el 200 (aviso) y en color verde los que no llegan a esos límites. La acumulación cambia y, tal y como recogen los informes del ayuntamiento, se produce a medida que el tráfico aumenta por lo que tiene un efecto tardío.
	
	\imagen{MapaNO2}{\footnotesize{Detalle mapa \ce{NO2} (\textit{MapBox}). Fuente: Elaboración propia.}\label{MapaNO2}}
	
	\item \textbf{Página 10} (ver figura \ref{NivelProtocolo}): para terminar un mapa de calor que indica el nivel del protocolo para los preavisos (mayor de 180). Sigue la línea del mapa anterior y es posible filtar por zona, hora del día y período.
	
	\imagen{NivelProtocolo}{\footnotesize{Detalle nivel protocolo (\textit{MapBox}). Fuente: Elaboración propia.}\label{NivelProtocolo}}
	
	\item \textbf{Páginas extra}: también se ha experimentado con otro tipo de gráficos (en este caso siempre con niveles de \ce{NO2}) en los que se puede ver de manera simple, cual es la zona más afectada por tamaño de las palabras, figura \ref{nubePalabras}, en un gráfico de palabras; o dependiendo de la estación/año, figura \ref{powerBitamanos}, en un gráfico de rectángulos. 
		\imagen{nubePalabras}{\footnotesize{Ejemplo gráfico nube de palabras.}\label{nubePalabras}}
	
	
	\imagen{powerBitamanos}{\footnotesize{Ejemplo gráfico por tamaño/año. Fuente: Elaboración propia.}\label{powerBitamanos}}
	
	
\end{itemize}


